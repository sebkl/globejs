<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>github.com/sebkl/globejs</title>
    <link href='http://fonts.googleapis.com/css?family=Michroma' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="third-party/three.min.js"></script>
    <script type="text/javascript" src="third-party/Tween.js"></script>
    <script type="text/javascript" src="../gotojs/engine.js"></script>
    <script type="text/javascript" src="globe.js"></script>
    <script type="text/javascript">
var globe;
var gui;

var lc = new THREE.Color(0x5f5fff);
var tc = new Array(180*2);
var callcount = 0;
for (var i = 0; i < 180*2; i++) {
	tc[i] = new Array(90*2);
}

function Next() {
	var messages = GOTOJS.Tweets.Next();
	var map ={};
	var max = 0;
	for (var i in messages) {
		var message = messages[i];
		var tweet = message.payload;

		if (tweet != null) {

			var lo = tweet['long'];
			var la = -tweet['lat'];
			var opco = GLOBE.GEO.lookup_country(lo,la);

			var imgs = tweet.images;

			if (imgs != null && imgs.length > 0) {
				addImage(imgs[0]);
				globe.createSourceParticle(lo,la);
			} else if (tweet['retweet']) {
				globe.createSourceParticle(lo,la,[255,255,255]);
			} else {
				globe.createSourceParticle(lo,la,[0,128,255]);
			}

			var x = parseInt(lo + 180);
			var y = parseInt(la + 90);
			tc[x][y] = tweet;

			if (map[opco] === undefined) {
				map[opco] = 0;
			}
			map[opco]++;
			if (map[opco] > max) {
				max = map[opco];
			}
		}		
	}
	for (var opco in map) {
		var val = map[opco]/max;
		globe.setCountryLightning(opco,new THREE.Color(val*lc.r,val*lc.g,val*lc.b));
	}
	callcount++;

	scroll(500);
	setTimeout(Next,500);
};

function Start() {
	console.log("Globe initialized, starting twitter stream");
	Next();
}

$(document).bind("globe:initialized",Start);

$(document).bind("country:hover", function(e,iso) {
		var w = $('#flagwidget');
		if (iso == null) {
			w.hide();
		} else {
			w.find("p").html(GLOBE.GEO.lookup_countryname(iso))
			w.css("background-image", "url(" + GLOBE.HELPER.flagUrl(iso)+ ")");
			w.show();
		}
});

$(document).bind('polar:hover', function (e,lo,la) {
	var x = parseInt(lo +180);
	var y = parseInt(la + 90);
	var tweet = tc[x][y];
	if (tweet !== undefined) {
		$('#tweet').find('.sender').html("@" + tweet.sender + ": ");
		$('#tweet').find('.text').html(tweet.text);
		var imgs = tweet.images;
		var img = $('#tweet').find('img');
		if (imgs != null && imgs.length > 0) {
			img.show();
			img.attr("src",imgs[0]);
		} else {
			img.hide();

		}
		$('#tweet').find('.text').html(tweet.text);
		$('#tweet').show();
	} else {
		$('#tweet').hide();
	}
});

function addImage(l) {
	var ni = $('<img>').addClass('picture').attr('src',l);
	$('#pics').append(ni);
}

function scroll(time) {
	var imgs = $("#pics").find('img');
	var tr = Math.round((imgs.length - 60)/3);
	if (tr >= 1) {
		var easing = "linear";

		if (tr < 5) {
			tr = 1
		} else {
			tr = tr - 3
		}

		var mo = tr*100;
		$('#pics').animate({
			top: "-="+mo
		},time,easing,function() {
			$('#pics').css('top','-100px');
			for (var i = 0; i <tr;i++) {
				$('#pics').find('img')[0].remove();
				$('#pics').find('img')[0].remove();
				$('#pics').find('img')[0].remove();
			}
		});
	}
}

$(document).ready(function() {
	globe = GLOBE.TYPES.Globe('#container');
	globe.start();
	GLOBE.WIDGETS.renderShareBar('#sharebar');
});

    </script>
    <style>
	    html,body,div#container {width:100%;height:100%;margin:0px;background-color:#000000}
	    #sharebar { position:absolute; left: 10px; bottom:10px }
	    #flagwidget { position:absolute; left: 50%; top: 25px; margin-left: -80px; width: 160px; height: 80px; opacity: 0.5; border: 1px solid #aaaaaa; background-repeat: no-repeat; display: none}
	    #flagwidget p {position:relative; width: 300px; top: -30px; font-family: 'Michroma'; font-size: 9pt; color: #ffffff}
	    #tweet { display: none; position:absolute; top: 10px; left: 10px; margin: 5px; border: 0px solid #eaff00; color: #ffffff; font-family: 'Michroma'; font-size: 9pt; max-width: 30%;}
	    h1.sender {font-family: 'Michroma'; font-size: 10pt; color: #4296ff; display: inline;}
	    #tweet p { margin: 10px, font-family: 'Courier';}
	    img.picture { border: 0px; width: 200px; height: 200px;}
	    #pics img.picture { opacity: 0.7; border: 0px; width: 96px; height: 96px; margin: 2px;}
	    #pics img.picture:hover { opacity:1.0;}
	    #pics { position: absolute; right: 0px; top: -100px; border: 0px; height: 100%; width: 300px; opacity: 1.0;}
    </style>
  </head>
  <body>
    <div id="container"></div>
    <div id="sharebar"></div>
    <div id="flagwidget"><p></p></div>
    <div id="tweet"><h1 class="sender"></h1><p class="text"></p><img class="picture" border="0"/></div>
    <div id="pics"></div>
  </body>
</html>
